/* @flow weak */

const knit = require('@knit/knit-core');
const needle = require('@knit/needle');

const tasks = [
  {
    title: 'discovering modules',
    task: ctx => {
      const modules = knit.findPublicModules(needle.paths);
      // More than 11 modules would cause node to throw:
      // (node) warning: possible EventEmitter memory leak detected. 11 exit listeners added. Use emitter.setMaxListeners() to increase limit.
      if (modules.length > 11) {
        // $FlowIgnore
        require('events').EventEmitter.defaultMaxListeners = modules.length; // eslint-disable-line
      }
      ctx.modules = modules;
      if (ctx.forceAll) {
        ctx.updated = modules;
      }
    },
  },
];

module.exports = tasks;
