/* @flow */

import type { TModules } from '@knit/knit-core';

const knit = require('@knit/knit-core');
const needle = require('@knit/needle');
const yarn = require('@knit/yarn-utils');

type TCtx = {
  modules: TModules,
  unpublished: TModules,
};

const tasks = [
  {
    title: 'finding unpublished modules',
    task: (ctx: TCtx) => Promise.all(ctx.modules.map(m => yarn.info(m)))
      .then(infos => infos.reduce((acc, info) => {
        const pkg = knit.readPkg(info.name, needle.paths);
        return !info.versions.includes(pkg.version)
          ? acc.concat(info.name)
          : acc;
      }, []))
      .then(modules => {
        ctx.unpublished = modules;
      }),
  },
];

module.exports = tasks;
