/* @flow */

const needle = require('@knit/needle');
const fs = require('fs-extra');
const multimatch = require('multimatch');

type TCtx = {
  modules: Array<string>,
  updated: Array<string>,
  ignorePath: Array<string>,
};

const tasks = [
  {
    title: 'copying src files',
    task: (ctx: TCtx) => {
      fs.copySync(needle.paths.modulesStub, needle.paths.distStub, {
        filter: (src) => {
          const stub = src.replace(new RegExp(`^${needle.paths.modulesStub}/?`), '');

          if (!stub.length || (stub.split('/').length === 1 && stub[0] === '@')) {
            return true;
          }

          const keep = ctx.updated.some(pattern => stub.startsWith(pattern));
          const drop = ctx.ignorePath ? multimatch([stub], ctx.ignorePath).length : false;

          return keep && !drop;
        },
      });

      return ctx;
    },
  },
];

module.exports = tasks;
