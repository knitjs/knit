/* @flow weak */

module.exports = (context, opts) => {
  const options = Object.assign(
    {
      loose: true,
      targets: {
        browsers: ['last 2 versions'],
      },
    },
    opts,
    { modules: process.env.JS_NEXT ? false : 'commonjs' }
  );
  const presets = [
    require.resolve('babel-preset-react'),
    [require.resolve('babel-preset-env'), options],
  ];

  const devPlugins = [
    // Adds component stack to warning messages
    require.resolve('babel-plugin-transform-react-jsx-source'),
    // Adds __self attribute to JSX which React will use for some warnings
    require.resolve('babel-plugin-transform-react-jsx-self'),
  ];

  const env = process.env.BABEL_ENV || process.env.NODE_ENV;

  const plugins = env === 'development'
    ? [...devPlugins, require.resolve('react-hot-loader/babel')]
    : [];

  return {
    presets,
    plugins,
  };
};
