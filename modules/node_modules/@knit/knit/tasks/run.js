/* @flow */


import type { TModules } from '@knit/knit-core';

const Listr = require('listr');

const knit = require('@knit/knit-core');
const needle = require('@knit/needle');
const yarn = require('@knit/yarn-utils');

type TCtx = {
  modules: TModules,
  updated: TModules,
  script: string,
  args: Array<string>,
};

const tasks = [
  {
    title: 'npm run',
    task: (ctx: TCtx) => (
      new Listr(ctx.updated.map(m => ({
        title: m,
        skip: () => !(knit.readPkg(m, needle.paths).scripts || {})[ctx.script],
        task: () => yarn.run(ctx.script, ctx.args, { cwd: knit.pathJoin(needle.paths.modules, m) }),
      })), { concurrent: false })
    ),
  },
];

module.exports = tasks;
