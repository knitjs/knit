/* @flow */

const updateNotifier = require('update-notifier');
const readPkgUp = require('read-pkg-up');

const pkg = readPkgUp.sync({ cwd: __dirname }).pkg;

require('yargs') // eslint-disable-line no-unused-expressions
  .version(pkg.version)
  .command('list [modules...]', 'list modules and their dependencies',
  (yargs) => (
    yargs
      .options({
        d: {
          alias: 'dependencies',
          describe: 'show dependencies for each module',
          type: 'boolean',
        },
        u: {
          alias: 'updated',
          describe: 'limit search to updated modules',
          type: 'boolean',
        },
      })
  ), require('./cli-list'))
  .command('validate', 'validate modules for release', require('./cli-validate'))
  .command('server', 'start a dev server',
    (yargs) => (
      yargs
        .options({
          p: {
            alias: 'port',
            description: 'set server port',
            type: 'number',
          },
          h: {
            alias: 'host',
            description: 'set server host',
            type: 'string',
          },
          r: {
            alias: 'proxy',
            description: 'set proxy uri',
            type: 'string',
          },
        })
    ), require('./cli-play'))
  .command('schema', 'update graphql schema', yargs => yargs.help(), require('./cli-relay'))
  .command('version <version>', 'version updated modules',
  (y) => (
    y
      .demand(1)
      .options('f', {
        alias: 'force-all',
        description: 'version all modules',
      })
      .options('s', {
        alias: 'skip-preflight',
        description: 'skip preflight checks (not recommended)',
      })
  ), require('./cli-version'))
  .command('build', 'build updated modules',
  (y) => (
    y
      .options('f', {
        alias: 'force-all',
        description: 'build all modules.',
      })
      .options('s', {
        alias: 'skip-preflight',
        description: 'skip preflight checks (not recommended)',
      })
  ), require('./cli-build'))
  .command('stitch', 'update the package.json of all modules with knitted dependencies and project meta data',
  (y) => (
    y
      .options('f', {
        alias: 'force-all',
        description: 'publish all modules',
      })
      .options('s', {
        alias: 'skip-preflight',
        description: 'skip preflight checks (not recommended)',
      })
  ), require('./cli-stitch'))
  .command('publish', 'publish updated modules',
  (y) => (
    y
      .options('f', {
        alias: 'force-all',
        description: 'publish all modules',
      })
      .options('s', {
        alias: 'skip-preflight',
        description: 'skip preflight checks (not recommended)',
      })
  ), require('./cli-publish'))
  .command('release <version>', 'run full release pipeline on updated modules.\nversion > build > knit > publish > push',
  (y) => (
    y
      .demand(1)
      .options('f', {
        alias: 'force-all',
        description: 'release all modules',
      })
      .options('s', {
        alias: 'skip-preflight',
        description: 'skip preflight checks (not recommended)',
      })
  ), require('./cli-release'))
  .demand(1)
  .help()
  .argv;

const notifier = updateNotifier({
  pkg,
  updateCheckInterval: 1000 * 60 * 60 * 24 * 7, // 1 week
});
notifier.notify();
